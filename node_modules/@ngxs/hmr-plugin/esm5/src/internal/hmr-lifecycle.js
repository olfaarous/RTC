/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { HmrBeforeDestroyAction } from '../actions/hmr-before-destroy.action';
/**
 * @template T, S
 */
var /**
 * @template T, S
 */
HmrLifecycle = /** @class */ (function () {
    function HmrLifecycle(ngAppModule, bootstrap, storage, context, options) {
        this.ngAppModule = ngAppModule;
        this.bootstrap = bootstrap;
        this.storage = storage;
        this.context = context;
        this.options = options;
    }
    /**
     * @param {?} hmrAfterOnInit
     * @return {?}
     */
    HmrLifecycle.prototype.hmrNgxsStoreOnInit = /**
     * @param {?} hmrAfterOnInit
     * @return {?}
     */
    function (hmrAfterOnInit) {
        /** @type {?} */
        var moduleHmrInit = this.getModuleHmrInitCallback();
        moduleHmrInit = moduleHmrInit.bind(this.ngAppModule);
        this.stateEventLoop((/**
         * @param {?} ctx
         * @param {?} state
         * @return {?}
         */
        function (ctx, state) {
            moduleHmrInit(ctx, state);
            hmrAfterOnInit(ctx, state);
        }));
    };
    /**
     * @private
     * @return {?}
     */
    HmrLifecycle.prototype.getModuleHmrInitCallback = /**
     * @private
     * @return {?}
     */
    function () {
        if (typeof this.ngAppModule.hmrNgxsStoreOnInit === 'function') {
            return this.ngAppModule.hmrNgxsStoreOnInit;
        }
        return (/**
         * @param {?} ctx
         * @param {?} state
         * @return {?}
         */
        function defaultModuleHmrInit(ctx, state) {
            ctx.patchState(state);
        });
    };
    /**
     * @return {?}
     */
    HmrLifecycle.prototype.hmrNgxsStoreBeforeOnDestroy = /**
     * @return {?}
     */
    function () {
        /** @type {?} */
        var state = {};
        /** @type {?} */
        var ctx = this.context.createStateContext();
        if (typeof this.ngAppModule.hmrNgxsStoreBeforeOnDestroy === 'function') {
            state = this.ngAppModule.hmrNgxsStoreBeforeOnDestroy(ctx);
        }
        else {
            state = ctx.getState();
        }
        ctx.dispatch(new HmrBeforeDestroyAction(state));
        return state;
    };
    /**
     * @private
     * @param {?} callback
     * @return {?}
     */
    HmrLifecycle.prototype.stateEventLoop = /**
     * @private
     * @param {?} callback
     * @return {?}
     */
    function (callback) {
        var _this = this;
        if (!this.storage.hasData())
            return;
        /** @type {?} */
        var appBootstrapped$ = this.bootstrap.appBootstrapped$;
        /** @type {?} */
        var state$ = this.context.store.select((/**
         * @param {?} state
         * @return {?}
         */
        function (state) { return state; }));
        appBootstrapped$.subscribe((/**
         * @return {?}
         */
        function () {
            /** @type {?} */
            var eventId;
            /** @type {?} */
            var storeEventId = state$.subscribe((/**
             * @return {?}
             */
            function () {
                // setTimeout used for zone detection after set hmr state
                clearInterval(eventId);
                eventId = window.setTimeout((/**
                 * @return {?}
                 */
                function () {
                    // close check on the message queue
                    storeEventId.unsubscribe();
                    // if events are no longer running on the call stack,
                    // then we can update the state
                    callback(_this.context.createStateContext(), (/** @type {?} */ (_this.storage.snapshot)));
                }), _this.options.deferTime);
            }));
        }));
    };
    return HmrLifecycle;
}());
/**
 * @template T, S
 */
export { HmrLifecycle };
if (false) {
    /**
     * @type {?}
     * @private
     */
    HmrLifecycle.prototype.ngAppModule;
    /**
     * @type {?}
     * @private
     */
    HmrLifecycle.prototype.bootstrap;
    /**
     * @type {?}
     * @private
     */
    HmrLifecycle.prototype.storage;
    /**
     * @type {?}
     * @private
     */
    HmrLifecycle.prototype.context;
    /**
     * @type {?}
     * @private
     */
    HmrLifecycle.prototype.options;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG1yLWxpZmVjeWNsZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BuZ3hzL2htci1wbHVnaW4vIiwic291cmNlcyI6WyJzcmMvaW50ZXJuYWwvaG1yLWxpZmVjeWNsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7O0FBT0EsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7Ozs7QUFHOUU7Ozs7SUFDRSxzQkFDVSxXQUFjLEVBQ2QsU0FBMkIsRUFDM0IsT0FBc0IsRUFDdEIsT0FBcUMsRUFDckMsT0FBeUI7UUFKekIsZ0JBQVcsR0FBWCxXQUFXLENBQUc7UUFDZCxjQUFTLEdBQVQsU0FBUyxDQUFrQjtRQUMzQixZQUFPLEdBQVAsT0FBTyxDQUFlO1FBQ3RCLFlBQU8sR0FBUCxPQUFPLENBQThCO1FBQ3JDLFlBQU8sR0FBUCxPQUFPLENBQWtCO0lBQ2hDLENBQUM7Ozs7O0lBRUcseUNBQWtCOzs7O0lBQXpCLFVBQTBCLGNBQThCOztZQUNsRCxhQUFhLEdBQW1CLElBQUksQ0FBQyx3QkFBd0IsRUFBRTtRQUNuRSxhQUFhLEdBQUcsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDckQsSUFBSSxDQUFDLGNBQWM7Ozs7O1FBQUMsVUFBQyxHQUFHLEVBQUUsS0FBSztZQUM3QixhQUFhLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzFCLGNBQWMsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDN0IsQ0FBQyxFQUFDLENBQUM7SUFDTCxDQUFDOzs7OztJQUVPLCtDQUF3Qjs7OztJQUFoQztRQUNFLElBQUksT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLGtCQUFrQixLQUFLLFVBQVUsRUFBRTtZQUM3RCxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsa0JBQWtCLENBQUM7U0FDNUM7UUFDRDs7Ozs7UUFBTyxTQUFTLG9CQUFvQixDQUFDLEdBQUcsRUFBRSxLQUFLO1lBQzdDLEdBQUcsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDeEIsQ0FBQyxFQUFDO0lBQ0osQ0FBQzs7OztJQUVNLGtEQUEyQjs7O0lBQWxDOztZQUNNLEtBQUssR0FBZSxFQUFFOztZQUNwQixHQUFHLEdBQW9CLElBQUksQ0FBQyxPQUFPLENBQUMsa0JBQWtCLEVBQUU7UUFDOUQsSUFBSSxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUMsMkJBQTJCLEtBQUssVUFBVSxFQUFFO1lBQ3RFLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLDJCQUEyQixDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQzNEO2FBQU07WUFDTCxLQUFLLEdBQUcsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDO1NBQ3hCO1FBRUQsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLHNCQUFzQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFDaEQsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDOzs7Ozs7SUFFTyxxQ0FBYzs7Ozs7SUFBdEIsVUFBdUIsUUFBd0I7UUFBL0MsaUJBb0JDO1FBbkJDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRTtZQUFFLE9BQU87O1lBRTlCLGdCQUFnQixHQUF3QixJQUFJLENBQUMsU0FBUyxDQUFDLGdCQUFnQjs7WUFDdkUsTUFBTSxHQUFvQixJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxNQUFNOzs7O1FBQUMsVUFBQSxLQUFLLElBQUksT0FBQSxLQUFLLEVBQUwsQ0FBSyxFQUFDO1FBRXpFLGdCQUFnQixDQUFDLFNBQVM7OztRQUFDOztnQkFDckIsT0FBZTs7Z0JBQ2IsWUFBWSxHQUFpQixNQUFNLENBQUMsU0FBUzs7O1lBQUM7Z0JBQ2xELHlEQUF5RDtnQkFDekQsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDO2dCQUN2QixPQUFPLEdBQUcsTUFBTSxDQUFDLFVBQVU7OztnQkFBQztvQkFDMUIsbUNBQW1DO29CQUNuQyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUM7b0JBQzNCLHFEQUFxRDtvQkFDckQsK0JBQStCO29CQUMvQixRQUFRLENBQUMsS0FBSSxDQUFDLE9BQU8sQ0FBQyxrQkFBa0IsRUFBRSxFQUFFLG1CQUFBLEtBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxFQUFjLENBQUMsQ0FBQztnQkFDbkYsQ0FBQyxHQUFFLEtBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDN0IsQ0FBQyxFQUFDO1FBQ0osQ0FBQyxFQUFDLENBQUM7SUFDTCxDQUFDO0lBQ0gsbUJBQUM7QUFBRCxDQUFDLEFBN0RELElBNkRDOzs7Ozs7Ozs7O0lBM0RHLG1DQUFzQjs7Ozs7SUFDdEIsaUNBQW1DOzs7OztJQUNuQywrQkFBOEI7Ozs7O0lBQzlCLCtCQUE2Qzs7Ozs7SUFDN0MsK0JBQWlDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTmd4c0Jvb3RzdHJhcHBlciB9IGZyb20gJ0BuZ3hzL3N0b3JlL2ludGVybmFscyc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBTdGF0ZUNvbnRleHQgfSBmcm9tICdAbmd4cy9zdG9yZSc7XHJcblxyXG5pbXBvcnQgeyBIbXJPcHRpb25CdWlsZGVyIH0gZnJvbSAnLi9obXItb3B0aW9ucy1idWlsZGVyJztcclxuaW1wb3J0IHsgSG1yQ2FsbGJhY2ssIE5neHNIbXJMaWZlQ3ljbGUgfSBmcm9tICcuLi9zeW1ib2xzJztcclxuaW1wb3J0IHsgSG1yU3RhdGVDb250ZXh0RmFjdG9yeSB9IGZyb20gJy4vaG1yLXN0YXRlLWNvbnRleHQtZmFjdG9yeSc7XHJcbmltcG9ydCB7IEhtckJlZm9yZURlc3Ryb3lBY3Rpb24gfSBmcm9tICcuLi9hY3Rpb25zL2htci1iZWZvcmUtZGVzdHJveS5hY3Rpb24nO1xyXG5pbXBvcnQgeyBIbXJTdG9yYWdlIH0gZnJvbSAnLi9obXItc3RvcmFnZSc7XHJcblxyXG5leHBvcnQgY2xhc3MgSG1yTGlmZWN5Y2xlPFQgZXh0ZW5kcyBQYXJ0aWFsPE5neHNIbXJMaWZlQ3ljbGU8Uz4+LCBTPiB7XHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwcml2YXRlIG5nQXBwTW9kdWxlOiBULFxyXG4gICAgcHJpdmF0ZSBib290c3RyYXA6IE5neHNCb290c3RyYXBwZXIsXHJcbiAgICBwcml2YXRlIHN0b3JhZ2U6IEhtclN0b3JhZ2U8Uz4sXHJcbiAgICBwcml2YXRlIGNvbnRleHQ6IEhtclN0YXRlQ29udGV4dEZhY3Rvcnk8VCwgUz4sXHJcbiAgICBwcml2YXRlIG9wdGlvbnM6IEhtck9wdGlvbkJ1aWxkZXJcclxuICApIHt9XHJcblxyXG4gIHB1YmxpYyBobXJOZ3hzU3RvcmVPbkluaXQoaG1yQWZ0ZXJPbkluaXQ6IEhtckNhbGxiYWNrPFM+KSB7XHJcbiAgICBsZXQgbW9kdWxlSG1ySW5pdDogSG1yQ2FsbGJhY2s8Uz4gPSB0aGlzLmdldE1vZHVsZUhtckluaXRDYWxsYmFjaygpO1xyXG4gICAgbW9kdWxlSG1ySW5pdCA9IG1vZHVsZUhtckluaXQuYmluZCh0aGlzLm5nQXBwTW9kdWxlKTtcclxuICAgIHRoaXMuc3RhdGVFdmVudExvb3AoKGN0eCwgc3RhdGUpID0+IHtcclxuICAgICAgbW9kdWxlSG1ySW5pdChjdHgsIHN0YXRlKTtcclxuICAgICAgaG1yQWZ0ZXJPbkluaXQoY3R4LCBzdGF0ZSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0TW9kdWxlSG1ySW5pdENhbGxiYWNrKCk6IEhtckNhbGxiYWNrPFM+IHtcclxuICAgIGlmICh0eXBlb2YgdGhpcy5uZ0FwcE1vZHVsZS5obXJOZ3hzU3RvcmVPbkluaXQgPT09ICdmdW5jdGlvbicpIHtcclxuICAgICAgcmV0dXJuIHRoaXMubmdBcHBNb2R1bGUuaG1yTmd4c1N0b3JlT25Jbml0O1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZ1bmN0aW9uIGRlZmF1bHRNb2R1bGVIbXJJbml0KGN0eCwgc3RhdGUpIHtcclxuICAgICAgY3R4LnBhdGNoU3RhdGUoc3RhdGUpO1xyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBobXJOZ3hzU3RvcmVCZWZvcmVPbkRlc3Ryb3koKTogUGFydGlhbDxTPiB7XHJcbiAgICBsZXQgc3RhdGU6IFBhcnRpYWw8Uz4gPSB7fTtcclxuICAgIGNvbnN0IGN0eDogU3RhdGVDb250ZXh0PFM+ID0gdGhpcy5jb250ZXh0LmNyZWF0ZVN0YXRlQ29udGV4dCgpO1xyXG4gICAgaWYgKHR5cGVvZiB0aGlzLm5nQXBwTW9kdWxlLmhtck5neHNTdG9yZUJlZm9yZU9uRGVzdHJveSA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgICBzdGF0ZSA9IHRoaXMubmdBcHBNb2R1bGUuaG1yTmd4c1N0b3JlQmVmb3JlT25EZXN0cm95KGN0eCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBzdGF0ZSA9IGN0eC5nZXRTdGF0ZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGN0eC5kaXNwYXRjaChuZXcgSG1yQmVmb3JlRGVzdHJveUFjdGlvbihzdGF0ZSkpO1xyXG4gICAgcmV0dXJuIHN0YXRlO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzdGF0ZUV2ZW50TG9vcChjYWxsYmFjazogSG1yQ2FsbGJhY2s8Uz4pOiB2b2lkIHtcclxuICAgIGlmICghdGhpcy5zdG9yYWdlLmhhc0RhdGEoKSkgcmV0dXJuO1xyXG5cclxuICAgIGNvbnN0IGFwcEJvb3RzdHJhcHBlZCQ6IE9ic2VydmFibGU8Ym9vbGVhbj4gPSB0aGlzLmJvb3RzdHJhcC5hcHBCb290c3RyYXBwZWQkO1xyXG4gICAgY29uc3Qgc3RhdGUkOiBPYnNlcnZhYmxlPGFueT4gPSB0aGlzLmNvbnRleHQuc3RvcmUuc2VsZWN0KHN0YXRlID0+IHN0YXRlKTtcclxuXHJcbiAgICBhcHBCb290c3RyYXBwZWQkLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgIGxldCBldmVudElkOiBudW1iZXI7XHJcbiAgICAgIGNvbnN0IHN0b3JlRXZlbnRJZDogU3Vic2NyaXB0aW9uID0gc3RhdGUkLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgICAgLy8gc2V0VGltZW91dCB1c2VkIGZvciB6b25lIGRldGVjdGlvbiBhZnRlciBzZXQgaG1yIHN0YXRlXHJcbiAgICAgICAgY2xlYXJJbnRlcnZhbChldmVudElkKTtcclxuICAgICAgICBldmVudElkID0gd2luZG93LnNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgICAgLy8gY2xvc2UgY2hlY2sgb24gdGhlIG1lc3NhZ2UgcXVldWVcclxuICAgICAgICAgIHN0b3JlRXZlbnRJZC51bnN1YnNjcmliZSgpO1xyXG4gICAgICAgICAgLy8gaWYgZXZlbnRzIGFyZSBubyBsb25nZXIgcnVubmluZyBvbiB0aGUgY2FsbCBzdGFjayxcclxuICAgICAgICAgIC8vIHRoZW4gd2UgY2FuIHVwZGF0ZSB0aGUgc3RhdGVcclxuICAgICAgICAgIGNhbGxiYWNrKHRoaXMuY29udGV4dC5jcmVhdGVTdGF0ZUNvbnRleHQoKSwgdGhpcy5zdG9yYWdlLnNuYXBzaG90IGFzIFBhcnRpYWw8Uz4pO1xyXG4gICAgICAgIH0sIHRoaXMub3B0aW9ucy5kZWZlclRpbWUpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxufVxyXG4iXX0=